<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ML Anomaly Detection Dashboard - Enhanced Keylogger</title>
        <link rel="stylesheet"
            href="{{ url_for('static', filename='style.css') }}">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <style>
        .ml-dashboard {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .card-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .status-indicator {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-ready {
            background: #d4edda;
            color: #155724;
        }
        
        .status-training {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .metric-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .risk-score {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .risk-minimal {
            background: #d4edda;
            color: #155724;
        }
        
        .risk-low {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .risk-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .risk-high {
            background: #f8d7da;
            color: #721c24;
        }
        
        .risk-critical {
            background: #721c24;
            color: white;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .alerts-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .alert-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        
        .alert-critical {
            background: #f8d7da;
            border-color: #721c24;
        }
        
        .alert-high {
            background: #fff3cd;
            border-color: #856404;
        }
        
        .alert-medium {
            background: #d1ecf1;
            border-color: #0c5460;
        }
        
        .controls-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .control-group {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-right: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.8;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
    </head>
    <body>
        <div class="ml-dashboard">
            <div class="dashboard-header">
                <h1>ü§ñ ML Anomaly Detection Dashboard</h1>
                <p>Real-time monitoring and analysis of user behavior
                    patterns</p>
            </div>

            <div class="controls-panel">
                <div class="control-group">
                    <button class="btn btn-primary"
                        onclick="refreshDashboard()">üîÑ Refresh</button>
                    <button class="btn btn-secondary" onclick="exportData()">üìä
                        Export Data</button>
                </div>
                <div class="control-group">
                    <button class="btn btn-danger"
                        onclick="resetBaseline('behavioral')">Reset
                        Behavioral</button>
                    <button class="btn btn-danger"
                        onclick="resetBaseline('keystroke')">Reset
                        Keystroke</button>
                    <button class="btn btn-danger"
                        onclick="resetBaseline('threat')">Reset Threat</button>
                </div>
                <div class="control-group">
                    <label>Auto-refresh: </label>
                    <input type="checkbox" id="autoRefresh"
                        onchange="toggleAutoRefresh()" checked>
                    <span id="refreshStatus">ON</span>
                </div>
            </div>

            <div class="dashboard-grid">
                <!-- System Status Card -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">üîß System Status</div>
                        <div class="status-indicator"
                            id="systemStatus">Loading...</div>
                    </div>
                    <div id="systemMetrics" class="loading">Loading system
                        metrics...</div>
                </div>

                <!-- Current Risk Score Card -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">‚ö†Ô∏è Current Risk Level</div>
                        <div id="riskTrend">üìà</div>
                    </div>
                    <div class="risk-score" id="currentRisk">Loading...</div>
                    <div id="riskFactors"></div>
                </div>

                <!-- Behavioral Analytics Card -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">üß† Behavioral Analytics</div>
                        <div class="status-indicator"
                            id="behavioralStatus">Loading...</div>
                    </div>
                    <div id="behavioralMetrics" class="loading">Loading
                        behavioral metrics...</div>
                </div>

                <!-- Keystroke Dynamics Card -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">‚å®Ô∏è Keystroke Dynamics</div>
                        <div class="status-indicator"
                            id="keystrokeStatus">Loading...</div>
                    </div>
                    <div id="keystrokeMetrics" class="loading">Loading keystroke
                        metrics...</div>
                </div>

                <!-- Insider Threat Detection Card -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">üïµÔ∏è Insider Threat
                            Detection</div>
                        <div class="status-indicator"
                            id="threatStatus">Loading...</div>
                    </div>
                    <div id="threatMetrics" class="loading">Loading threat
                        metrics...</div>
                </div>

                <!-- Risk Scoring Card -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">üìä Risk Scoring</div>
                        <div class="status-indicator"
                            id="riskScoringStatus">Loading...</div>
                    </div>
                    <div id="riskScoringMetrics" class="loading">Loading risk
                        scoring metrics...</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">üìà Risk Score Trend</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="riskTrendChart"></canvas>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">üéØ Anomaly Detection</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="anomalyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Alerts Section -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">üö® Recent Alerts</div>
                    <div id="alertCount">0 alerts</div>
                </div>
                <div class="alerts-list" id="alertsList">
                    <div class="loading">Loading alerts...</div>
                </div>
            </div>
        </div>

        <script>
        let autoRefreshInterval;
        let riskTrendChart;
        let anomalyChart;
        
        // Initialize dashboard
        $(document).ready(function() {
            initializeCharts();
            refreshDashboard();
            toggleAutoRefresh();
        });
        
        function initializeCharts() {
            // Risk Trend Chart
            const riskCtx = document.getElementById('riskTrendChart').getContext('2d');
            riskTrendChart = new Chart(riskCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Risk Score',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });
            
            // Anomaly Detection Chart
            const anomalyCtx = document.getElementById('anomalyChart').getContext('2d');
            anomalyChart = new Chart(anomalyCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Normal', 'Behavioral', 'Keystroke', 'Insider Threat', 'High Risk'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#28a745',
                            '#17a2b8',
                            '#ffc107',
                            '#fd7e14',
                            '#dc3545'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        function refreshDashboard() {
            // Fetch ML system status
            $.get('/api/ml/status')
                .done(function(data) {
                    if (data.success) {
                        updateSystemStatus(data.ml_components);
                    } else {
                        showError('Failed to load ML status: ' + data.error);
                    }
                })
                .fail(function() {
                    showError('Failed to connect to ML API');
                });
            
            // Fetch current risk status
            $.get('/api/ml/risk/current')
                .done(function(data) {
                    if (data.success) {
                        updateRiskStatus(data.risk_status);
                    }
                })
                .fail(function() {
                    $('#currentRisk').html('<div class="error">Risk data unavailable</div>');
                });
            
            // Fetch recent alerts
            $.get('/api/ml/risk/alerts')
                .done(function(data) {
                    if (data.success) {
                        updateAlerts(data.alerts);
                    }
                })
                .fail(function() {
                    $('#alertsList').html('<div class="error">Alerts unavailable</div>');
                });
            
            // Fetch models status
            $.get('/api/ml/models/status')
                .done(function(data) {
                    if (data.success) {
                        updateModelsStatus(data.models_status);
                    }
                })
                .fail(function() {
                    showError('Failed to load models status');
                });
        }
        
        function updateSystemStatus(mlComponents) {
            let allReady = true;
            let totalComponents = 0;
            let readyComponents = 0;
            
            // Update individual component status
            for (const [component, stats] of Object.entries(mlComponents)) {
                totalComponents++;
                const isReady = stats.models_trained || stats.baseline_established;
                if (isReady) readyComponents++;
                else allReady = false;
                
                // Update component-specific metrics
                updateComponentMetrics(component, stats);
            }
            
            // Update system status indicator
            const systemStatus = document.getElementById('systemStatus');
            if (allReady) {
                systemStatus.textContent = 'Ready';
                systemStatus.className = 'status-indicator status-ready';
            } else {
                systemStatus.textContent = 'Training';
                systemStatus.className = 'status-indicator status-training';
            }
            
            // Update system metrics
            const systemMetrics = document.getElementById('systemMetrics');
            systemMetrics.innerHTML = `
                <div class="metric-grid">
                    <div class="metric-item">
                        <div class="metric-value">${readyComponents}/${totalComponents}</div>
                        <div class="metric-label">Components Ready</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value">${Object.keys(mlComponents).length}</div>
                        <div class="metric-label">Active Components</div>
                    </div>
                </div>
            `;
        }
        
        function updateComponentMetrics(component, stats) {
            const componentMap = {
                'behavioral_analytics': 'behavioral',
                'keystroke_dynamics': 'keystroke',
                'insider_threat': 'threat',
                'risk_scoring': 'riskScoring'
            };
            
            const elementId = componentMap[component];
            if (!elementId) return;
            
            // Update status indicator
            const statusElement = document.getElementById(elementId + 'Status');
            if (statusElement) {
                if (stats.models_trained || stats.baseline_established) {
                    statusElement.textContent = 'Ready';
                    statusElement.className = 'status-indicator status-ready';
                } else {
                    statusElement.textContent = 'Training';
                    statusElement.className = 'status-indicator status-training';
                }
            }
            
            // Update metrics
            const metricsElement = document.getElementById(elementId + 'Metrics');
            if (metricsElement) {
                let metricsHtml = '<div class="metric-grid">';
                
                // Add component-specific metrics
                if (component === 'behavioral_analytics') {
                    metricsHtml += `
                        <div class="metric-item">
                            <div class="metric-value">${stats.events_processed || 0}</div>
                            <div class="metric-label">Events Processed</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${stats.anomalies_detected || 0}</div>
                            <div class="metric-label">Anomalies Detected</div>
                        </div>
                    `;
                } else if (component === 'keystroke_dynamics') {
                    metricsHtml += `
                        <div class="metric-item">
                            <div class="metric-value">${stats.keystrokes_processed || 0}</div>
                            <div class="metric-label">Keystrokes</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${stats.users_enrolled || 0}</div>
                            <div class="metric-label">Users Enrolled</div>
                        </div>
                    `;
                } else if (component === 'insider_threat') {
                    metricsHtml += `
                        <div class="metric-item">
                            <div class="metric-value">${stats.threats_detected || 0}</div>
                            <div class="metric-label">Threats Detected</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${(stats.threat_detection_rate * 100 || 0).toFixed(1)}%</div>
                            <div class="metric-label">Detection Rate</div>
                        </div>
                    `;
                } else if (component === 'risk_scoring') {
                    metricsHtml += `
                        <div class="metric-item">
                            <div class="metric-value">${stats.alerts_generated || 0}</div>
                            <div class="metric-label">Alerts Generated</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${(stats.current_risk_score || 0).toFixed(2)}</div>
                            <div class="metric-label">Current Risk</div>
                        </div>
                    `;
                }
                
                metricsHtml += '</div>';
                metricsElement.innerHTML = metricsHtml;
            }
        }
        
        function updateRiskStatus(riskStatus) {
            const currentRisk = document.getElementById('currentRisk');
            const riskLevel = riskStatus.risk_level || 'unknown';
            const riskScore = riskStatus.current_score || 0;
            
            currentRisk.textContent = `${(riskScore * 100).toFixed(1)}% - ${riskLevel.toUpperCase()}`;
            currentRisk.className = `risk-score risk-${riskLevel}`;
            
            // Update risk factors
            const riskFactors = document.getElementById('riskFactors');
            if (riskStatus.risk_factors) {
                let factorsHtml = '<div class="metric-grid">';
                for (const [factor, score] of Object.entries(riskStatus.risk_factors)) {
                    factorsHtml += `
                        <div class="metric-item">
                            <div class="metric-value">${(score * 100).toFixed(0)}%</div>
                            <div class="metric-label">${factor.replace('_', ' ')}</div>
                        </div>
                    `;
                }
                factorsHtml += '</div>';
                riskFactors.innerHTML = factorsHtml;
            }
        }
        
        function updateAlerts(alerts) {
            const alertsList = document.getElementById('alertsList');
            const alertCount = document.getElementById('alertCount');
            
            alertCount.textContent = `${alerts.length} alerts`;
            
            if (alerts.length === 0) {
                alertsList.innerHTML = '<div class="loading">No recent alerts</div>';
                return;
            }
            
            let alertsHtml = '';
            alerts.forEach(alert => {
                const alertTime = new Date(alert.timestamp).toLocaleString();
                alertsHtml += `
                    <div class="alert-item alert-${alert.severity}">
                        <div><strong>${alert.severity.toUpperCase()}</strong> - ${alert.description || 'Alert triggered'}</div>
                        <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                            ${alertTime} | Score: ${(alert.risk_score * 100).toFixed(1)}%
                        </div>
                    </div>
                `;
            });
            
            alertsList.innerHTML = alertsHtml;
        }
        
        function updateModelsStatus(modelsStatus) {
            // Update individual component status based on models
            for (const [component, status] of Object.entries(modelsStatus)) {
                const componentMap = {
                    'behavioral_analytics': 'behavioral',
                    'keystroke_dynamics': 'keystroke',
                    'insider_threat_detector': 'threat',
                    'risk_scorer': 'riskScoring'
                };
                
                const elementId = componentMap[component];
                if (elementId) {
                    const statusElement = document.getElementById(elementId + 'Status');
                    if (statusElement) {
                        if (status.models_trained) {
                            statusElement.textContent = 'Ready';
                            statusElement.className = 'status-indicator status-ready';
                        } else {
                            statusElement.textContent = 'Training';
                            statusElement.className = 'status-indicator status-training';
                        }
                    }
                }
            }
        }
        
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            const status = document.getElementById('refreshStatus');
            
            if (checkbox.checked) {
                autoRefreshInterval = setInterval(refreshDashboard, 30000); // 30 seconds
                status.textContent = 'ON';
                status.style.color = '#28a745';
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                }
                status.textContent = 'OFF';
                status.style.color = '#dc3545';
            }
        }
        
        function resetBaseline(type) {
            if (!confirm(`Are you sure you want to reset the ${type} baseline? This action cannot be undone.`)) {
                return;
            }
            
            const endpoints = {
                'behavioral': '/api/ml/behavioral/reset',
                'keystroke': '/api/ml/keystroke/reset',
                'threat': '/api/ml/threat/reset'
            };
            
            const endpoint = endpoints[type];
            if (!endpoint) return;
            
            $.post(endpoint)
                .done(function(data) {
                    if (data.success) {
                        alert(`${type} baseline reset successfully`);
                        refreshDashboard();
                    } else {
                        alert(`Failed to reset ${type} baseline: ` + data.error);
                    }
                })
                .fail(function() {
                    alert(`Failed to reset ${type} baseline`);
                });
        }
        
        function exportData() {
            $.post('/api/ml/export/data', JSON.stringify({type: 'all'}), 'json')
                .done(function(data) {
                    if (data.success) {
                        // Create download link
                        const blob = new Blob([JSON.stringify(data.export_data, null, 2)], 
                                            {type: 'application/json'});
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `ml_data_export_${new Date().toISOString().slice(0, 19)}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                    } else {
                        alert('Failed to export data: ' + data.error);
                    }
                })
                .fail(function() {
                    alert('Failed to export data');
                });
        }
        
        function showError(message) {
            console.error(message);
            // You could show a toast notification here
        }
    </script>
    </body>
</html>