{% extends "base.html" %}

{% block title %}ML Dashboard - Enhanced Keylogger{% endblock %}
{% block page_title %}ML Dashboard{% endblock %}

{% block toolbar %}
<div class="btn-group" role="group" aria-label="ML dashboard controls">
  <button type="button" class="btn btn-outline-primary btn-sm" aria-label="Refresh ML dashboard" onclick="refreshDashboard()">
    <i class="fas fa-sync-alt"></i> Refresh
  </button>
  <button type="button" class="btn btn-outline-secondary btn-sm" aria-label="Export ML data" onclick="exportData()">
    <i class="fas fa-download"></i> Export
  </button>
</div>
<div class="btn-group ms-2" role="group" aria-label="Reset baselines">
  <button type="button" class="btn btn-danger btn-sm" onclick="resetBaseline('behavioral')">
    <i class="fas fa-brain"></i> Reset Behavioral
  </button>
  <button type="button" class="btn btn-danger btn-sm" onclick="resetBaseline('keystroke')">
    <i class="fas fa-keyboard"></i> Reset Keystroke
  </button>
  <button type="button" class="btn btn-danger btn-sm" onclick="resetBaseline('threat')">
    <i class="fas fa-user-secret"></i> Reset Threat
  </button>
</div>
<div class="form-check form-switch ms-3">
  <input class="form-check-input" type="checkbox" id="autoRefresh" checked onchange="toggleAutoRefresh()">
  <label class="form-check-label" for="autoRefresh">Auto-refresh <span id="refreshStatus" class="ms-1">ON</span></label>
</div>
{% endblock %}

{% block content %}
<!-- Status Tiles -->
<div class="row mb-4">
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="stat-tile">
      <div>
        <div class="text-muted small mb-1">ML System</div>
        <div class="h5 mb-0"><span id="systemStatus" class="badge badge-soft-secondary">Loading...</span></div>
      </div>
      <div class="icon"><i class="fas fa-robot"></i></div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="stat-tile">
      <div>
        <div class="text-muted small mb-1">Current Risk</div>
        <div class="h5 mb-0" id="currentRiskTile">0% - UNKNOWN</div>
      </div>
      <div class="icon"><i class="fas fa-exclamation-triangle"></i></div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="stat-tile">
      <div>
        <div class="text-muted small mb-1">Alerts (last 24h)</div>
        <div class="h5 mb-0" id="alertCount">0</div>
      </div>
      <div class="icon"><i class="fas fa-bell"></i></div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="stat-tile">
      <div>
        <div class="text-muted small mb-1">Components Ready</div>
        <div class="h5 mb-0" id="componentsReady">0/0</div>
      </div>
      <div class="icon"><i class="fas fa-cogs"></i></div>
    </div>
  </div>
</div>

<!-- Component Status & Metrics -->
<div class="row mb-4">
  <div class="col-lg-6 mb-4">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="m-0">System Status</h6>
        <span id="systemStatusBadge" class="badge bg-secondary">Loading</span>
      </div>
      <div class="card-body" id="systemMetrics"><div class="text-muted">Loading system metrics...</div></div>
    </div>
  </div>
  <div class="col-lg-6 mb-4">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="m-0">Current Risk Level</h6>
        <i class="fas fa-chart-line"></i>
      </div>
      <div class="card-body">
        <div id="currentRisk" class="alert alert-secondary text-center mb-3">Loading...</div>
        <div id="riskFactors" class="row g-3"></div>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-xl-6 mb-4">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="m-0">Behavioral Analytics</h6>
        <span id="behavioralStatus" class="badge bg-secondary">Loading</span>
      </div>
      <div class="card-body" id="behavioralMetrics"><div class="text-muted">Loading behavioral metrics...</div></div>
    </div>
  </div>
  <div class="col-xl-6 mb-4">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="m-0">Keystroke Dynamics</h6>
        <span id="keystrokeStatus" class="badge bg-secondary">Loading</span>
      </div>
      <div class="card-body" id="keystrokeMetrics"><div class="text-muted">Loading keystroke metrics...</div></div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-xl-6 mb-4">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="m-0">Insider Threat Detection</h6>
        <span id="threatStatus" class="badge bg-secondary">Loading</span>
      </div>
      <div class="card-body" id="threatMetrics"><div class="text-muted">Loading threat metrics...</div></div>
    </div>
  </div>
  <div class="col-xl-6 mb-4">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="m-0">Risk Scoring</h6>
        <span id="riskScoringStatus" class="badge bg-secondary">Loading</span>
      </div>
      <div class="card-body" id="riskScoringMetrics"><div class="text-muted">Loading risk scoring metrics...</div></div>
    </div>
  </div>
</div>

<!-- Charts -->
<div class="row mb-4">
  <div class="col-lg-6 mb-4">
    <div class="card h-100">
      <div class="card-header"><h6 class="m-0">Risk Score Trend</h6></div>
      <div class="card-body"><canvas id="riskTrendChart" height="220"></canvas></div>
    </div>
  </div>
  <div class="col-lg-6 mb-4">
    <div class="card h-100">
      <div class="card-header"><h6 class="m-0">Anomaly Detection</h6></div>
      <div class="card-body"><canvas id="anomalyChart" height="220"></canvas></div>
    </div>
  </div>
</div>

<!-- Alerts -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="m-0">Recent Alerts</h6>
        <span class="text-muted" id="alertCountLabel">0 alerts</span>
      </div>
      <div class="card-body">
        <div class="list-group" id="alertsList"><div class="text-muted">Loading alerts...</div></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
let autoRefreshInterval, riskTrendChart, anomalyChart;

document.addEventListener('DOMContentLoaded', () => { initializeCharts(); refreshDashboard(); toggleAutoRefresh(); });

function initializeCharts(){
  const riskCtx = document.getElementById('riskTrendChart').getContext('2d');
  riskTrendChart = new Chart(riskCtx,{type:'line',data:{labels:[],datasets:[{label:'Risk Score',data:[],borderColor:'#667eea',backgroundColor:'rgba(102,126,234,0.1)',tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:1}}}});
  const anomalyCtx = document.getElementById('anomalyChart').getContext('2d');
  anomalyChart = new Chart(anomalyCtx,{type:'doughnut',data:{labels:['Normal','Behavioral','Keystroke','Insider Threat','High Risk'],datasets:[{data:[0,0,0,0,0],backgroundColor:['#28a745','#17a2b8','#ffc107','#fd7e14','#dc3545']}]} ,options:{responsive:true,maintainAspectRatio:false}});
}

function refreshDashboard(){
    // Use AJAX to refresh data instead of full page reload
    Promise.all([
        fetch('/api/ml/status').then(r => r.json()),
        fetch('/api/ml/behavioral/baseline').then(r => r.json()),
        fetch('/api/ml/threat/summary').then(r => r.json()),
        fetch('/api/ml/risk/current').then(r => r.json())
    ]).then(([mlStatus, behavioral, threat, risk]) => {
        // Update ML status
        if (mlStatus.success) {
            updateMLStatus(mlStatus);
        }
        
        // Update behavioral analytics
        if (behavioral.success) {
            updateBehavioralData(behavioral);
        }
        
        // Update threat data
        if (threat.success) {
            updateThreatData(threat);
        }
        
        // Update risk data
        if (risk.success) {
            updateRiskData(risk);
        }
        
        console.log('Dashboard refreshed via AJAX');
    }).catch(error => {
        console.error('Error refreshing dashboard:', error);
    });
}

function updateMLStatus(data) {
    // Update ML status indicators
    const statusElements = document.querySelectorAll('.ml-status');
    statusElements.forEach(el => {
        if (data.models_trained) {
            el.textContent = 'Active';
            el.className = 'badge bg-success ml-status';
        } else {
            el.textContent = 'Training';
            el.className = 'badge bg-warning ml-status';
        }
    });
}

function updateBehavioralData(data) {
    // Update behavioral analytics data
    if (data.baseline_summary) {
        const summary = data.baseline_summary;
        document.querySelector('#behavioral-samples').textContent = summary.total_samples || '0';
        document.querySelector('#behavioral-anomalies').textContent = summary.anomalies_detected || '0';
    }
}

function updateThreatData(data) {
    // Update threat detection data
    if (data.summary) {
        const summary = data.summary;
        document.querySelector('#threat-incidents').textContent = summary.total_incidents || '0';
        document.querySelector('#threat-score').textContent = (summary.average_score || 0).toFixed(2);
    }
}

function updateRiskData(data) {
    // Update risk scoring data
    if (data.current_risk) {
        const risk = data.current_risk;
        document.querySelector('#current-risk').textContent = (risk.score || 0).toFixed(2);
        document.querySelector('#risk-level').textContent = risk.level || 'Low';
    }
}

function updateSystemStatus(ml){ let total=0,ready=0,allReady=true; for(const [comp,stats] of Object.entries(ml)){ total++; const isReady = !!(stats.models_trained||stats.baseline_established); if(isReady) ready++; else allReady=false; updateComponentMetrics(comp,stats);} const sys=document.getElementById('systemStatus'); if(sys){ sys.textContent = allReady?'Ready':'Training'; sys.className = 'badge '+(allReady?'bg-success':'bg-warning text-dark'); }
  const badge=document.getElementById('systemStatusBadge'); if(badge){ badge.className = 'badge '+(allReady?'bg-success':'bg-warning text-dark'); badge.textContent = allReady?'Ready':'Training'; }
  const cr=document.getElementById('componentsReady'); if(cr){ cr.textContent = `${ready}/${total}`; }
  const metrics=document.getElementById('systemMetrics'); if(metrics){ metrics.innerHTML = `<div class="row g-3"><div class="col"><div class="card card-body text-center"><div class="h5 mb-0">${ready}/${total}</div><div class="text-muted small">Components Ready</div></div></div><div class="col"><div class="card card-body text-center"><div class="h5 mb-0">${Object.keys(ml).length}</div><div class="text-muted small">Active Components</div></div></div></div>`; }
}

function updateComponentMetrics(component,stats){ const map={'behavioral_analytics':'behavioral','keystroke_dynamics':'keystroke','insider_threat':'threat','risk_scoring':'riskScoring'}; const id=map[component]; if(!id) return; const el=document.getElementById(id+'Status'); if(el){ const ready = !!(stats.models_trained||stats.baseline_established); el.className='badge '+(ready?'bg-success':'bg-warning text-dark'); el.textContent= ready?'Ready':'Training'; }
  const m=document.getElementById(id+'Metrics'); if(!m) return; let h='<div class="row g-3">'; if(component==='behavioral_analytics'){ h+=metric('Events Processed',stats.events_processed||0)+metric('Anomalies Detected',stats.anomalies_detected||0); }
  else if(component==='keystroke_dynamics'){ h+=metric('Keystrokes',stats.keystrokes_processed||0)+metric('Users Enrolled',stats.users_enrolled||0); }
  else if(component==='insider_threat'){ h+=metric('Threats Detected',stats.threats_detected||0)+metric('Detection Rate',(((stats.threat_detection_rate||0)*100).toFixed(1)+'%')); }
  else if(component==='risk_scoring'){ h+=metric('Alerts Generated',stats.alerts_generated||0)+metric('Current Risk',(stats.current_risk_score||0).toFixed(2)); }
  h+='</div>'; m.innerHTML=h; }

function metric(label,value){ return `<div class="col-6"><div class="card card-body text-center"><div class="h5 mb-0">${value}</div><div class="text-muted small">${label}</div></div></div>`; }

function updateRiskStatus(rs){ const riskLevel = rs.risk_level||'unknown'; const riskScore = rs.current_score||0; const el=document.getElementById('currentRisk'); if(el){ el.className = 'alert text-center mb-3 '+riskAlertClass(riskLevel); el.textContent = `${(riskScore*100).toFixed(1)}% - ${riskLevel.toUpperCase()}`; } const tile=document.getElementById('currentRiskTile'); if(tile){ tile.textContent = `${(riskScore*100).toFixed(1)}% - ${riskLevel.toUpperCase()}`; }
  const rf=document.getElementById('riskFactors'); if(rf && rs.risk_factors){ let h=''; for(const [f,s] of Object.entries(rs.risk_factors)){ h+=metric(f.replace('_',' '),(s*100).toFixed(0)+'%'); } rf.innerHTML = `<div class="row g-3">${h}</div>`; }
  if(riskTrendChart){ const t=new Date().toLocaleTimeString(); riskTrendChart.data.labels.push(t); riskTrendChart.data.datasets[0].data.push(riskScore); if(riskTrendChart.data.labels.length>30){ riskTrendChart.data.labels.shift(); riskTrendChart.data.datasets[0].data.shift(); } riskTrendChart.update(); }
}

function riskAlertClass(level){ if(level==='minimal') return 'alert-success'; if(level==='low') return 'alert-info'; if(level==='medium') return 'alert-warning'; if(level==='high'||level==='critical') return 'alert-danger'; return 'alert-secondary'; }

function updateAlerts(alerts){ const list=document.getElementById('alertsList'); const lbl=document.getElementById('alertCountLabel'); const count=document.getElementById('alertCount'); const n=alerts.length; if(lbl) lbl.textContent = `${n} alerts`; if(count) count.textContent = n; if(n===0){ list.innerHTML='<div class="text-muted">No recent alerts</div>'; return; } let h=''; alerts.forEach(a=>{ const t=new Date(a.timestamp).toLocaleString(); const sev=a.severity||'info'; h+=`<div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"><div><strong class="text-${sev==='critical'?'danger':(sev==='high'?'warning':'info')}">${sev.toUpperCase()}</strong> - ${a.description||'Alert triggered'}</div><small class="text-muted">${t} | Score: ${(a.risk_score*100).toFixed(1)}%</small></div>`; }); list.innerHTML=h; }

function updateModelsStatus(models){ const map={'behavioral_analytics':'behavioral','keystroke_dynamics':'keystroke','insider_threat_detector':'threat','risk_scorer':'riskScoring'}; for(const [comp,st] of Object.entries(models)){ const id=map[comp]; if(!id) continue; const el=document.getElementById(id+'Status'); if(el){ if(st.models_trained){ el.className='badge bg-success'; el.textContent='Ready'; } else { el.className='badge bg-warning text-dark'; el.textContent='Training'; } } } }

function toggleAutoRefresh(){ const cb=document.getElementById('autoRefresh'); const st=document.getElementById('refreshStatus'); if(cb.checked){ autoRefreshInterval=setInterval(refreshDashboard,30000); st.textContent='ON'; st.classList.remove('text-danger'); st.classList.add('text-success'); } else { if(autoRefreshInterval) clearInterval(autoRefreshInterval); st.textContent='OFF'; st.classList.remove('text-success'); st.classList.add('text-danger'); } }

function resetBaseline(type){ if(!confirm(`Reset the ${type} baseline? This action cannot be undone.`)) return; const endpoints={'behavioral':'/api/ml/behavioral/reset','keystroke':'/api/ml/keystroke/reset','threat':'/api/ml/threat/reset'}; const ep=endpoints[type]; if(!ep) return; $.post(ep).done(d=>{ if(d.success){ if(window.showToast) window.showToast('success', `${type} baseline reset`); else alert(`${type} baseline reset`); refreshDashboard(); } else { alert(`Failed to reset ${type}: `+d.error); } }).fail(()=>alert(`Failed to reset ${type}`)); }

function exportData(){ $.post('/api/ml/export/data', JSON.stringify({type:'all'}), 'json').done(d=>{ if(d.success){ const blob=new Blob([JSON.stringify(d.export_data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`ml_data_export_${new Date().toISOString().slice(0,19)}.json`; a.click(); URL.revokeObjectURL(url); } else { alert('Failed to export data: '+d.error); } }).fail(()=>alert('Failed to export data')); }

function showError(msg){ console.error(msg); if(window.showToast) window.showToast('danger', msg); }
</script>
{% endblock %}