{% extends "base.html" %}

{% block title %}Logs - Keylogger{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div
                    class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title m-0">Activity Logs</h3>
                </div>
                <div class="card-body">
                    <div class="row mb-3 g-3">
                        <div class="col-md-3">
                            <label for="eventType">Event Type:</label>
                            <select class="form-control" id="eventType">
                                <option value>All Events</option>
                                <option value="keyboard">Keyboard</option>
                                <option value="mouse">Mouse</option>
                                <option value="window">Window</option>
                                <option value="clipboard">Clipboard</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="windowFilter">Window Filter:</label>
                            <input type="text" class="form-control"
                                id="windowFilter"
                                placeholder="Filter by window...">
                        </div>
                        <div class="col-md-3">
                            <label for="searchQuery">Search Text:</label>
                            <input type="text" class="form-control" id="searchQuery" placeholder="Search in details...">
                        </div>
                        <div class="col-md-3">
                            <label>&nbsp;</label><br>
                            <button class="btn btn-primary me-2" onclick="applyFilters(1)">Filter</button>
                            <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
                        </div>
                    </div>

                    <div id="activeFilters" class="mb-2"></div>

                    <div id="loadingIndicator" class="text-muted" style="display:none;">Loading logs...</div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Event Type</th>
                                    <th>Details</th>
                                    <th>Window</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody">
                                {% if logs %}
                                {% for log in logs %}
                                <tr>
                                    <td>{{ log.timestamp }}</td>
                                    <td><span class="badge bg-info text-dark">{{
                                            log.type }}</span></td>
                                    <td>{{ log.message }}</td>
                                    <td>{{ log.window or '' }}</td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="4"
                                        class="text-center text-muted">No logs
                                        available</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <nav aria-label="Logs pagination">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Dynamic pagination -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const state = {
    page: 1,
    perPage: 50,
    type: '',
    window: '',
    q: ''
};

function setLoading(isLoading) {
    const el = document.getElementById('loadingIndicator');
    if (!el) return;
    el.style.display = isLoading ? 'block' : 'none';
}

function updateFilterSummary() {
    const container = document.getElementById('activeFilters');
    if (!container) return;
    container.innerHTML = '';
    const items = [];
    if (state.type) items.push(`<span class="badge bg-secondary me-2">Type: ${state.type}</span>`);
    if (state.window) items.push(`<span class="badge bg-secondary me-2">Window: ${state.window}</span>`);
    if (state.q) items.push(`<span class="badge bg-secondary">Query: ${state.q}</span>`);
    if (items.length) {
        container.innerHTML = `<div class="small text-muted">Active Filters:</div>` + items.join(' ');
    }
}

async function fetchLogs(page = 1) {
    try {
        setLoading(true);
        const params = new URLSearchParams();
        params.set('page', page);
        params.set('per_page', state.perPage);
        if (state.type) params.set('type', state.type);
        if (state.window) params.set('window', state.window);
        if (state.q) params.set('q', state.q);
        const res = await fetch(`/api/logs?${params.toString()}`);
        const data = await res.json();
        renderLogs(data.logs || []);
        buildPagination(data.pagination || { page: 1, pages: 1 });
    } catch (e) {
        console.error('Failed to fetch logs', e);
        const tbody = document.getElementById('logsTableBody');
        if (tbody) tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Error loading logs</td></tr>`;
    } finally {
        setLoading(false);
    }
}

function renderLogs(logs) {
    const tbody = document.getElementById('logsTableBody');
    tbody.innerHTML = '';

    if (!logs || logs.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">No logs match current filters</td></tr>`;
        return;
    }

    for (const item of logs) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item.timestamp || ''}</td>
            <td><span class="badge bg-info text-dark">${item.type || 'Log'}</span></td>
            <td>${item.message || ''}</td>
            <td>${item.window || ''}</td>
        `;
        tbody.appendChild(tr);
    }
}

function buildPagination(pagination) {
    const ul = document.getElementById('pagination');
    ul.innerHTML = '';

    const current = pagination.page || 1;
    const totalPages = pagination.pages || 1;

    function addPage(label, page, disabled = false, active = false) {
        const li = document.createElement('li');
        li.className = `page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}`;
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = label;
        a.onclick = (e) => {
            e.preventDefault();
            if (!disabled && !active) {
                applyFilters(page);
            }
        };
        li.appendChild(a);
        ul.appendChild(li);
    }

    addPage('Previous', Math.max(1, current - 1), current === 1, false);

    // Show up to 5 pages around current
    const start = Math.max(1, current - 2);
    const end = Math.min(totalPages, start + 4);

    for (let p = start; p <= end; p++) {
        addPage(String(p), p, false, p === current);
    }

    addPage('Next', Math.min(totalPages, current + 1), current === totalPages, false);
}

function applyFilters(page = 1) {
    state.page = page;
    state.type = document.getElementById('eventType').value;
    state.window = document.getElementById('windowFilter').value.trim();
    state.q = document.getElementById('searchQuery').value.trim();
    updateFilterSummary();
    fetchLogs(state.page);
}

function clearFilters() {
    document.getElementById('eventType').value = '';
    document.getElementById('windowFilter').value = '';
    document.getElementById('searchQuery').value = '';
    state.type = '';
    state.window = '';
    state.q = '';
    updateFilterSummary();
    applyFilters(1);
}

// Initial load
window.addEventListener('DOMContentLoaded', () => {
    applyFilters(1);
});
</script>
{% endblock %}