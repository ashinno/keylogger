{% extends "base.html" %}

{% block title %}Configuration - Keylogger{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div
                    class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title m-0">Keylogger Configuration</h3>
                    <div>
                        <button type="button" class="btn btn-primary"
                            onclick="saveConfig()">
                            <i class="fas fa-save me-1"></i> Save
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <form id="configForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="m-0">Logging Settings</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label for="logLevel">Log
                                                Level:</label>
                                            <select class="form-control"
                                                id="logLevel"
                                                name="logging.level">
                                                <option
                                                    value="DEBUG">DEBUG</option>
                                                <option value="INFO"
                                                    selected>INFO</option>
                                                <option
                                                    value="WARNING">WARNING</option>
                                                <option
                                                    value="ERROR">ERROR</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="logFile">Log
                                                File:</label>
                                            <input type="text"
                                                class="form-control"
                                                id="logFile" name="logging.file"
                                                value="keylogger.log">
                                        </div>
                                        <div class="form-group">
                                            <label for="maxLogSize">Max Log Size
                                                (MB):</label>
                                            <input type="number"
                                                class="form-control"
                                                id="maxLogSize"
                                                name="logging.max_size_mb"
                                                value="10">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="m-0">Performance
                                            Settings</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label for="bufferSize">Buffer
                                                Size:</label>
                                            <input type="number"
                                                class="form-control"
                                                id="bufferSize"
                                                name="performance.buffer_size"
                                                value="1000">
                                        </div>
                                        <div class="form-group">
                                            <label for="flushInterval">Flush
                                                Interval (seconds):</label>
                                            <input type="number"
                                                class="form-control"
                                                id="flushInterval"
                                                name="performance.flush_interval"
                                                value="30">
                                        </div>
                                        <div class="form-group">
                                            <label
                                                for="screenshotInterval">Screenshot
                                                Interval (seconds):</label>
                                            <input type="number"
                                                class="form-control"
                                                id="screenshotInterval"
                                                name="performance.screenshot_interval"
                                                value="60">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3 mt-0">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="m-0">Feature Toggles</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                type="checkbox"
                                                id="enableKeyboard"
                                                name="features.keyboard_logging"
                                                checked>
                                            <label class="form-check-label"
                                                for="enableKeyboard">
                                                Enable Keyboard Logging
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                type="checkbox" id="enableMouse"
                                                name="features.mouse_logging"
                                                checked>
                                            <label class="form-check-label"
                                                for="enableMouse">
                                                Enable Mouse Logging
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                type="checkbox"
                                                id="enableClipboard"
                                                name="features.clipboard_monitoring"
                                                checked>
                                            <label class="form-check-label"
                                                for="enableClipboard">
                                                Enable Clipboard Monitoring
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                type="checkbox"
                                                id="enableScreenshots"
                                                name="features.screenshot_monitoring"
                                                checked>
                                            <label class="form-check-label"
                                                for="enableScreenshots">
                                                Enable Screenshot Monitoring
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                type="checkbox"
                                                id="enableCamera"
                                                name="features.camera">
                                            <label class="form-check-label"
                                                for="enableCamera">
                                                Enable Camera Monitoring
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="m-0">Web Interface</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label for="webPort">Web
                                                Port:</label>
                                            <input type="number"
                                                class="form-control"
                                                id="webPort" name="web.port"
                                                value="5000">
                                        </div>
                                        <div class="form-group">
                                            <label for="webHost">Web
                                                Host:</label>
                                            <input type="text"
                                                class="form-control"
                                                id="webHost" name="web.host"
                                                value="127.0.0.1">
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                type="checkbox" id="enableAuth"
                                                name="web.auth_enabled" checked>
                                            <label class="form-check-label"
                                                for="enableAuth">
                                                Enable Authentication
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Privacy Settings -->
                        <div class="row g-3 mt-0">
                            <div class="col-md-12">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h4 class="m-0">ML Risk Scoring Settings</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group mb-2">
                                                    <label for="riskBaselineWindow">Baseline Window</label>
                                                    <input type="number" class="form-control" id="riskBaselineWindow" name="ml.risk_scoring.baseline_window" placeholder="1000">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <label for="riskDriftThreshold">Drift Threshold</label>
                                                    <input type="number" step="0.01" class="form-control" id="riskDriftThreshold" name="ml.risk_scoring.drift_threshold" placeholder="0.15">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group mb-2">
                                                    <label for="riskMicroBatchSize">Micro-batch Size</label>
                                                    <input type="number" class="form-control" id="riskMicroBatchSize" name="ml.risk_scoring.micro_batch_size" placeholder="32">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <label for="riskMaxLatencyMs">Max Latency (ms)</label>
                                                    <input type="number" class="form-control" id="riskMaxLatencyMs" name="ml.risk_scoring.max_latency_ms" placeholder="200">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="m-0">Privacy Settings</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox" id="sanitizePasswords" name="privacy.sanitize_passwords">
                                                    <label class="form-check-label" for="sanitizePasswords">
                                                        Sanitize Passwords
                                                    </label>
                                                </div>
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox" id="hashSensitiveData" name="privacy.hash_sensitive_data">
                                                    <label class="form-check-label" for="hashSensitiveData">
                                                        Hash Sensitive Data
                                                    </label>
                                                </div>
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox" id="logMouseCoords" name="privacy.log_mouse_coordinates">
                                                    <label class="form-check-label" for="logMouseCoords">
                                                        Log Mouse Coordinates
                                                    </label>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="coordPrecision" class="form-label">Coordinate Precision</label>
                                                    <input type="number" class="form-control" id="coordPrecision" name="privacy.coordinate_precision" min="0" max="6" step="1" value="2">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="clipboardMaxLen" class="form-label">Clipboard Max Length</label>
                                                    <input type="number" class="form-control" id="clipboardMaxLen" name="privacy.clipboard_max_length" min="0" step="1" value="1024">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="excludedApps" class="form-label">Excluded Applications (one per line)</label>
                                                    <textarea class="form-control" id="excludedApps" name="privacy.excluded_applications" rows="5" data-list-delimiter="newline" placeholder="e.g. KeePass&#10;1Password&#10;LastPass"></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="sensitiveKeywords" class="form-label">Sensitive Keywords (comma-separated)</label>
                                                    <textarea class="form-control" id="sensitiveKeywords" name="privacy.sensitive_keywords" rows="5" data-list-delimiter="comma" placeholder="password, ssn, credit card, otp"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function saveConfig() {
    const form = document.getElementById('configForm');
    const payload = {};

    const elements = form.querySelectorAll('input, select, textarea');
    elements.forEach(el => {
        if (!el.name) return;
        let value;
        if (el.type === 'checkbox') {
            value = el.checked;
        } else if (el.dataset && el.dataset.listDelimiter) {
            const raw = el.value || '';
            if (el.dataset.listDelimiter === 'newline') {
                value = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
            } else {
                value = raw.split(',').map(s => s.trim()).filter(Boolean);
            }
        } else if (el.type === 'number') {
            const num = el.value;
            value = num === '' ? null : Number(num);
        } else {
            value = el.value;
        }
        payload[el.name] = value; // Use dot-notation keys as expected by backend
    });

    // Normalize aliases to canonical keys for backend
    if (Object.prototype.hasOwnProperty.call(payload, 'features.clipboard_monitoring')) {
        payload['features.clipboard'] = payload['features.clipboard_monitoring'];
        // Remove alias to avoid conflicting updates and ensure canonical wins server-side
        delete payload['features.clipboard_monitoring'];
    }
    
    fetch('/api/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json().catch(() => ({ success: false, message: 'Invalid JSON response' })))
    .then(data => {
        if (data && data.success) {
            if (window.showToast) { showToast('success', 'Configuration saved successfully!'); } else { alert('Configuration saved successfully!'); }
        } else {
            const err = (data && (data.error || data.message)) || 'Unknown error';
            if (window.showToast) { showToast('error', 'Error saving configuration: ' + err); } else { alert('Error saving configuration: ' + err); }
        }
    })
    .catch(error => {
        if (window.showToast) { showToast('error', 'Error saving configuration: ' + error); } else { alert('Error saving configuration: ' + error); }
    });
}

function loadConfig() {
    fetch('/api/config')
        .then(r => r.json())
        .then(data => {
            const cfg = (data && data.config) ? data.config : data; // Support both shapes
            if (!cfg) return;

            const setChecked = (name, val) => {
                const el = document.querySelector(`[name="${name}"]`);
                if (el) el.checked = !!val;
            };
            const setValue = (name, val) => {
                const el = document.querySelector(`[name="${name}"]`);
                if (!el || val == null) return;
                if (el.dataset && el.dataset.listDelimiter === 'newline' && Array.isArray(val)) {
                    el.value = val.join('\n');
                } else if (el.dataset && el.dataset.listDelimiter === 'comma' && Array.isArray(val)) {
                    el.value = val.join(', ');
                } else {
                    el.value = val;
                }
            };

            // Logging
            if (cfg.logging) {
                setValue('logging.level', cfg.logging.level);
                setValue('logging.file', cfg.logging.file);
                setValue('logging.max_size_mb', cfg.logging.max_size_mb);
            }

            // Performance
            if (cfg.performance) {
                setValue('performance.buffer_size', cfg.performance.buffer_size);
                setValue('performance.flush_interval', cfg.performance.flush_interval);
                setValue('performance.screenshot_interval', cfg.performance.screenshot_interval);
            }

            // ML Risk Scoring
            if (cfg.ml && cfg.ml.risk_scoring) {
                setValue('ml.risk_scoring.baseline_window', cfg.ml.risk_scoring.baseline_window);
                setValue('ml.risk_scoring.drift_threshold', cfg.ml.risk_scoring.drift_threshold);
                setValue('ml.risk_scoring.micro_batch_size', cfg.ml.risk_scoring.micro_batch_size);
                setValue('ml.risk_scoring.max_latency_ms', cfg.ml.risk_scoring.max_latency_ms);
            }

            // Web
            if (cfg.web) {
                setValue('web.port', cfg.web.port);
                setValue('web.host', cfg.web.host);
                setChecked('web.auth_enabled', cfg.web.auth_enabled);
            }

            // Features (best-effort: keys may vary)
            if (cfg.features) {
                setChecked('features.keyboard_logging', cfg.features.keyboard_logging ?? cfg.features.keyboard);
                setChecked('features.mouse_logging', cfg.features.mouse_logging ?? cfg.features.mouse);
                setChecked('features.clipboard_monitoring', cfg.features.clipboard_monitoring ?? cfg.features.clipboard);
                setChecked('features.screenshot_monitoring', cfg.features.screenshot_monitoring ?? cfg.features.screenshots);
                setChecked('features.camera', cfg.features.camera ?? (cfg.camera && cfg.camera.enabled));
            }

            // Privacy
            const p = cfg.privacy || {};
            setChecked('privacy.sanitize_passwords', p.sanitize_passwords);
            setChecked('privacy.hash_sensitive_data', p.hash_sensitive_data);
            setChecked('privacy.log_mouse_coordinates', p.log_mouse_coordinates);
            setValue('privacy.coordinate_precision', p.coordinate_precision);
            setValue('privacy.clipboard_max_length', p.clipboard_max_length);

            setValue('privacy.excluded_applications', p.excluded_applications);
            setValue('privacy.sensitive_keywords', p.sensitive_keywords);
        })
        .catch(() => {});
}

document.addEventListener('DOMContentLoaded', loadConfig);
</script>
{% endblock %}