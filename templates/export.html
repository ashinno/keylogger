{% extends "base.html" %}

{% block title %}Export - Keylogger{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div
                    class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title m-0">Export Data</h3>
                    <div>
                        <button class="btn btn-outline-secondary me-2"
                            onclick="previewData()">
                            <i class="fas fa-eye me-1"></i> Preview
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-download me-1"></i> Export
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <form id="exportForm">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="m-0">Format</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                type="radio" name="format"
                                                id="formatJson" value="json"
                                                checked>
                                            <label class="form-check-label"
                                                for="formatJson">JSON</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                type="radio" name="format"
                                                id="formatCsv" value="csv">
                                            <label class="form-check-label"
                                                for="formatCsv">CSV</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                type="radio" name="format"
                                                id="formatTxt" value="txt">
                                            <label class="form-check-label"
                                                for="formatTxt">TXT</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="m-0">Date Range</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label for="startDate">Start
                                                Date:</label>
                                            <input type="date"
                                                class="form-control"
                                                id="startDate"
                                                name="start_date">
                                        </div>
                                        <div class="form-group">
                                            <label for="endDate">End
                                                Date:</label>
                                            <input type="date"
                                                class="form-control"
                                                id="endDate" name="end_date">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="m-0">Event Types</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                type="checkbox"
                                                id="eventsKeystrokes"
                                                name="events" value="keystrokes"
                                                checked>
                                            <label class="form-check-label"
                                                for="eventsKeystrokes">Keystrokes</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                type="checkbox"
                                                id="eventsMouseClicks"
                                                name="events"
                                                value="mouse_clicks" checked>
                                            <label class="form-check-label"
                                                for="eventsMouseClicks">Mouse
                                                Clicks</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                type="checkbox"
                                                id="eventsClipboard"
                                                name="events" value="clipboard"
                                                checked>
                                            <label class="form-check-label"
                                                for="eventsClipboard">Clipboard</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                type="checkbox"
                                                id="eventsScreenshots"
                                                name="events"
                                                value="screenshots" checked>
                                            <label class="form-check-label"
                                                for="eventsScreenshots">Screenshots</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1"
    aria-labelledby="previewModalLabel" aria-hidden="true">
    <div
        class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">Preview Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre class="mb-0"><code id="previewContent"></code></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                    data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
function getFormData() {
    const form = document.getElementById('exportForm');
    const formData = new FormData(form);
    const params = {
        format: formData.get('format'),
        start_date: formData.get('start_date') || '',
        end_date: formData.get('end_date') || '',
        events: formData.getAll('events')
    };
    return params;
}

function exportData() {
    const params = getFormData();
    const query = new URLSearchParams(params).toString();
    window.location.href = `/api/export?${query}`;
}

function previewData() {
    const params = getFormData();
    fetch('/api/export/preview', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(params)
    })
    .then(res => res.json())
    .then(data => {
        const previewEl = document.getElementById('previewContent');
        previewEl.textContent = (typeof data === 'string') ? data : JSON.stringify(data, null, 2);
        const modalEl = document.getElementById('previewModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    })
    .catch(err => {
        const previewEl = document.getElementById('previewContent');
        previewEl.textContent = 'Error fetching preview: ' + err;
        const modalEl = document.getElementById('previewModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    });
}

// Set default dates
(function setDefaultDates() {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - 7);
    document.getElementById('startDate').value = start.toISOString().substr(0,10);
    document.getElementById('endDate').value = end.toISOString().substr(0,10);
})();
</script>
{% endblock %}